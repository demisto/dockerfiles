# PowerShell Pattern: Token Manipulation
# Detects access token manipulation for privilege escalation

id: PS-018
name: Token Manipulation
description: |
  Detects PowerShell code that manipulates Windows access tokens for privilege
  escalation or impersonation. Token manipulation allows attackers to execute
  code with elevated privileges or impersonate other users. This pattern identifies
  common token manipulation APIs and techniques including token duplication and
  impersonation.
languages:
  - powershell
detection_type: regex
detection_logic: '(?i)(?:DuplicateToken|ImpersonateLoggedOnUser|SetThreadToken|AdjustTokenPrivileges|Invoke-TokenManipulation|Get-System)'
severity: High
mitre_technique: T1134
confidence: 0.9
category: privilege_escalation
enabled: true
metadata:
  author: Script Sentinel Team
  created: "2025-11-17"
  updated: "2025-11-17"
  references:
    - "https://attack.mitre.org/techniques/T1134/"
    - "https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens"
  tags:
    - powershell
    - token-manipulation
    - privilege-escalation
    - impersonation
  examples:
    - "Invoke-TokenManipulation -ImpersonateUser -Username 'SYSTEM'"
    - "[Advapi32]::DuplicateToken($hToken, 2, [ref]$hDupToken)"
    - "$result = [Advapi32]::ImpersonateLoggedOnUser($hToken)"
    - "Get-System # Common function name for SYSTEM token theft"