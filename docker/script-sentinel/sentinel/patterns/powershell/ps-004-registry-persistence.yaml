# PowerShell Pattern: Registry Persistence
# Detects registry modification for persistence mechanisms

id: PS-004
name: Registry Persistence Mechanism
description: |
  Detects PowerShell commands that modify registry Run keys or other common
  persistence locations. Attackers frequently use registry modifications to
  maintain persistence on compromised systems. This pattern identifies attempts
  to add or modify registry keys in common autorun locations.
languages:
  - powershell
detection_type: regex
detection_logic: '(?i)(?:Set-ItemProperty|New-ItemProperty|reg\s+add).*(?:HKCU|HKLM).*\\(?:Run|RunOnce|RunServices|RunServicesOnce|Winlogon|Explorer\\Run)'
severity: High
mitre_technique: T1547.001
confidence: 0.9
category: persistence
enabled: true
metadata:
  author: Script Sentinel Team
  created: "2025-11-17"
  updated: "2025-11-17"
  references:
    - "https://attack.mitre.org/techniques/T1547/001/"
    - "https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys"
  tags:
    - powershell
    - persistence
    - registry
    - autorun
  examples:
    - "Set-ItemProperty -Path 'HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run' -Name 'Updater' -Value 'C:\\malware.exe'"
    - "New-ItemProperty -Path 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run' -Name 'SecurityUpdate'"
    - "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Backdoor /d C:\\evil.exe"